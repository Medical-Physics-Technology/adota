# Scripts

This directory contains utility scripts for running and evaluating DoTA models.

## run_model.py

A command-line tool for running DoTA model inference on dose prediction tasks.

### Usage

```bash
uv run python scripts/run_model.py <MODEL_NAME> <TEST_DATA> [OPTIONS]
```

### Arguments

| Argument | Type | Required | Description |
|----------|------|----------|-------------|
| `MODEL_NAME` | string | Yes | Name of the model directory (located in `models/`) |
| `TEST_DATA` | path | Yes | Path to the directory with input data to evaluate |

### Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--downsampling-method` | string | `interpolation` | Downsampling method: `interpolation` or `avg_pooling` |
| `--model-fname` | string | `best_model.pth` | Model filename within the model directory |
| `--device-index` | int | `0` | CUDA device index (-1 for CPU) |
| `--dose-threshold` | float | `2.0` | Dose percent threshold for gamma calculation |
| `--distance-threshold` | float | `2.0` | Distance threshold (mm) for gamma calculation |
| `--no-progress` | flag | `False` | Disable progress bar |
| `--verbose` | flag | `False` | Enable verbose/debug output |
| `--help` | - | - | Show help message and exit |

### Examples

**Basic usage with example data:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs
```

**Specify a different downsampling method:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs --downsampling-method avg_pooling
```

**Use a specific model checkpoint:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs --model-fname checkpoint_epoch_100.pth
```

**Run on CPU instead of GPU:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs --device-index -1
```

**Custom gamma parameters:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs \
    --dose-threshold 3.0 \
    --distance-threshold 3.0
```

**Combine multiple options:**
```bash
uv run python scripts/run_model.py DoTA_v3_grid_search_v11 data/example_inputs \
    --downsampling-method interpolation \
    --model-fname best_model.pth \
    --device-index 0 \
    --verbose
```

**Show help:**
```bash
uv run python scripts/run_model.py --help
```

### Input Data Format

The `TEST_DATA` directory should contain input files with the following naming convention:
- `<uuid>_ct.npy` - CT scan data
- `<uuid>_ds.npy` - Dose distribution (ground truth)
- `<uuid>_ds_pred.npy` - Predicted dose distribution (generated by script)
- `<uuid>_flux.npy` - Flux data
- `<uuid>_sim_res.json` - Simulation results

The script will automatically detect unique sample IDs from the filenames.

### Output

Each run creates a timestamped directory in `runs/` with the format `YYYYMMDD_HHMMSS`:

```
runs/
└── 20260203_143022/
    ├── evaluation.log          # Complete log with results table
    └── figures/
        ├── gpr_vs_energy.png   # Plot of Gamma Pass Rate vs Energy
        ├── Best_E<energy>MeV.svg
        ├── Worst_E<energy>MeV.svg
        └── Closest_to_Mean_E<energy>MeV.svg
```

Additionally, predicted dose files (`<uuid>_ds_pred.npy`) are saved in the test data directory.

### Requirements

The model directory must contain:
- Model weights file (default: `best_model.pth`)
- `hyperparams.json` - Model hyperparameters configuration file
